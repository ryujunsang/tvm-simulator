<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVM 시뮬레이터</title>
    <style>
        :root {
            --color-background: #fcfcf9;
            --color-surface: #fffffe;
            --color-text: #13343b;
            --color-text-secondary: #626c71;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-secondary: rgba(94, 82, 64, 0.12);
            --color-border: rgba(94, 82, 64, 0.2);
            --color-success: #21808d;
            --color-error: #c0152f;
            --color-warning: #a84b2f;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #1f2121;
                --color-surface: #262828;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-secondary: rgba(119, 124, 124, 0.15);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-success: #32b8c6;
                --color-error: #ff5459;
                --color-warning: #e6816d;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--color-text);
        }

        .subtitle {
            color: var(--color-text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--color-text);
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        select, input {
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
        }

        select:focus, input:focus {
            outline: 2px solid var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.2);
        }

        .column-visual {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .column-container {
            position: relative;
            width: 100%;
            height: 750px; /* 높이 확장: 450px -> 750px */
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: linear-gradient(to bottom, var(--color-surface) 0%, rgba(33, 128, 141, 0.05) 100%);
            overflow: hidden;
        }

        .all-columns-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .mini-column {
            position: relative;
            height: 200px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: linear-gradient(to bottom, var(--color-surface) 0%, rgba(33, 128, 141, 0.05) 100%);
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mini-column:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(33, 128, 141, 0.2);
        }

        .mini-column.selected {
            border-color: var(--color-primary);
            border-width: 3px;
        }

        .mini-column-header {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .mini-tube {
            width: 20px;
            height: 30px;
            background: linear-gradient(135deg, #2da6b2 0%, #21808d 100%);
            border: 1px solid #1d7480;
            border-radius: 10px;
            margin: 2px auto;
            font-size: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            font-size: 11px;
            color: var(--color-text-secondary);
            text-align: center;
        }

        .sensor-indicator {
            position: absolute;
            right: 15px;
            width: 60px;
            height: 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s;
            opacity: 0.6;
            z-index: 25;
        }

        .sensor-indicator.active {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 20px currentColor;
        }

        .sensor-sf {
            top: 20px; /* 위로 조정 */
            background: rgba(192, 21, 47, 0.15);
            color: var(--color-error);
            border: 2px solid rgba(192, 21, 47, 0.3);
        }

        .sensor-sf.active {
            background: var(--color-error);
            color: white;
            border-color: var(--color-error);
        }

        .sensor-sc {
            bottom: 20px; /* 아래로 조정 (dispenser 위) */
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-primary);
            border: 2px solid rgba(33, 128, 141, 0.3);
        }

        .sensor-sc.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .sensor-so {
            bottom: 80px;
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-success);
            border: 2px solid rgba(33, 128, 141, 0.3);
        }

        .sensor-so.active {
            background: var(--color-success);
            color: white;
            border-color: var(--color-success);
        }

        .sensor-status {
            font-size: 8px;
            margin-top: 2px;
            opacity: 0.8;
        }

        .tube {
            position: absolute;
            width: 40px;
            height: 60px;
            background: linear-gradient(135deg, #2da6b2 0%, #21808d 100%);
            border: 2px solid #1d7480;
            border-radius: 20px;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(33, 128, 141, 0.3);
            z-index: 5;
        }

        .tube.falling {
            transition: bottom 1s cubic-bezier(0.4, 0, 0.6, 1);
        }

        .tube.dispensing {
            transition: bottom 0.8s cubic-bezier(0.6, 0, 1, 1), opacity 0.3s ease-out 0.5s;
        }

        .dual-column-display {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 200px;
            display: flex;
            justify-content: space-between;
            padding: 10px;
        }

        .single-column-view {
            position: relative;
            width: 48%;
            height: 100%;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: linear-gradient(to bottom, transparent 0%, rgba(33, 128, 141, 0.03) 100%);
        }

        .column-label {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text);
            background: var(--color-surface);
            padding: 2px 10px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
            z-index: 20;
        }

        .sensor-left {
            left: 10px !important;
            right: auto !important;
        }

        .sensor-right {
            right: 10px !important;
            left: auto !important;
        }

        .tube-stack-container {
            position: absolute;
            top: 50px; /* 위쪽 여백 조정 */
            left: 0;
            right: 0;
            bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .tube-stack-left .tube,
        .tube-stack-right .tube {
            width: 35px;
            height: 55px;
            font-size: 11px;
        }

        .dispenser-unit {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(to bottom, transparent 0%, var(--color-surface) 30%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .motor-housing {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 30px;
            background: var(--color-secondary);
            border: 2px solid var(--color-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text);
            z-index: 10;
        }

        .motor-direction-indicator {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--color-text-secondary);
            font-weight: bold;
        }

        .rotating-disc {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--color-surface) 0%, var(--color-secondary) 100%);
            border: 3px solid var(--color-border);
            transition: transform 0.05s linear;
            z-index: 5;
        }

        .disc-marker {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 15px;
            background: var(--color-primary);
            border-radius: 2px;
        }

        /* 푸셔암 스타일 개선 */
        .pusher-arm {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px; /* 디스크 반지름보다 약간 작게 */
            height: 8px;
            background: linear-gradient(90deg, #e6816d 0%, #a84b2f 100%); /* 오렌지색 계열로 강조 */
            transform-origin: 0% 50%; /* 중심축 회전 */
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 6;
        }

        .pusher-head {
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #c0152f;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        .sh-sensor-indicator {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(119, 124, 124, 0.3);
            border: 2px solid var(--color-border);
            transition: all 0.3s;
            z-index: 15;
        }

        .sh-sensor-indicator.active {
            background: var(--color-success);
            border-color: var(--color-success);
            box-shadow: 0 0 15px var(--color-success);
        }

        .sh11 {
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
        }

        .sh12 {
            bottom: 30%;
            left: 20%;
        }

        .sh13 {
            bottom: 30%;
            right: 20%;
        }

        .output-port {
            position: absolute;
            bottom: 10px;
            width: 60px;
            height: 40px;
            background: var(--color-secondary);
            border: 2px solid var(--color-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--color-text-secondary);
            transition: all 0.3s;
            z-index: 8;
        }

        .output-port.active {
            background: rgba(33, 128, 141, 0.2);
            border-color: var(--color-primary);
            color: var(--color-primary);
            box-shadow: 0 0 15px rgba(33, 128, 141, 0.3);
        }

        .port-left {
            left: 30px;
        }

        .port-right {
            right: 30px;
        }

        .motor-status-panel {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            color: var(--color-text-secondary);
            z-index: 10;
        }

        .tube.dispensing-left {
            transition: all 0.6s ease-out;
        }

        .tube.dispensing-right {
            transition: all 0.6s ease-out;
        }

        .sensor-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .sensor-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--color-secondary);
            border-radius: 6px;
            transition: all 0.3s;
        }

        .sensor-row.active {
            background: rgba(33, 128, 141, 0.2);
            border-left: 3px solid var(--color-primary);
        }

        .sensor-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
        }

        .sensor-desc {
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }

        .sensor-led {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(119, 124, 124, 0.3);
            transition: all 0.3s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .sensor-led.active {
            background: var(--color-success);
            box-shadow: 0 0 12px var(--color-success);
        }

        .log-container {
            grid-column: 1 / -1;
        }

        .log-box {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 6px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            border-left: 3px solid transparent;
        }

        .log-deposit {
            background: rgba(33, 128, 141, 0.1);
            border-left-color: var(--color-primary);
        }

        .log-withdraw {
            background: rgba(168, 75, 47, 0.1);
            border-left-color: var(--color-warning);
        }

        .log-error {
            background: rgba(192, 21, 47, 0.1);
            border-left-color: var(--color-error);
        }

        .log-sensor {
            background: rgba(119, 124, 124, 0.1);
            border-left-color: var(--color-text-secondary);
        }

        .timestamp {
            color: var(--color-text-secondary);
            margin-right: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: var(--color-secondary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .all-columns-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TVM 시뮬레이터</h1>
        <p class="subtitle">튜브 입출고 및 센서 동작을 실시간으로 시뮬레이션합니다</p>

        <div class="main-layout">
            <div class="card">
                <h2>제어 패널</h2>
                <div class="control-panel">
                    <div class="control-group">
                        <label>현재 선택 컬럼</label>
                        <select id="columnSelect" onchange="selectColumn(parseInt(this.value))">
                            <option value="1">컬럼 1 (M1)</option>
                            <option value="2">컬럼 2 (M1)</option>
                            <option value="3">컬럼 3 (M2)</option>
                            <option value="4">컬럼 4 (M2)</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>최대 튜브 용량</label>
                        <input type="number" id="maxCapacity" value="12" min="1" max="15">
                    </div>

                    <button class="btn btn-primary" onclick="depositTube()">튜브 입고 (Deposit)</button>
                    <button class="btn btn-secondary" onclick="withdrawTube()">튜브 출고 (Withdraw)</button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">시뮬레이션 초기화</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="tubeCount">0</div>
                        <div class="stat-label">현재 튜브 수</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="depositCount">0</div>
                        <div class="stat-label">총 입고</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="withdrawCount">0</div>
                        <div class="stat-label">총 출고</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="errorCount">0</div>
                        <div class="stat-label">에러 발생</div>
                    </div>
                </div>

                <h2 style="margin-top: 25px; font-size: 16px;">모든 컬럼 상태</h2>
                <div class="all-columns-grid" id="allColumnsGrid"></div>
            </div>

            <div class="card">
                <h2>모터 시각화 (Motor <span id="motorLabel2">M1</span> - Column <span id="motorColumns">1, 2</span>)</h2>
                <div class="column-visual">
                    <div class="column-container" id="columnContainer">
                        <div class="dual-column-display">
                            <div class="single-column-view" id="column1View">
                                <div class="column-label">Column 1</div>
                                <div class="sensor-indicator sensor-sf sensor-left" id="sensorSF1">
                                    <div>SF1</div>
                                </div>
                                <div class="sensor-indicator sensor-sc sensor-left" id="sensorSC1">
                                    <div>SC1</div>
                                </div>
                                <div class="tube-stack-container tube-stack-left" id="tubeStackContainer1"></div>
                            </div>
                            
                            <div class="single-column-view" id="column2View">
                                <div class="column-label">Column 2</div>
                                <div class="sensor-indicator sensor-sf sensor-right" id="sensorSF2">
                                    <div>SF2</div>
                                </div>
                                <div class="sensor-indicator sensor-sc sensor-right" id="sensorSC2">
                                    <div>SC2</div>
                                </div>
                                <div class="tube-stack-container tube-stack-right" id="tubeStackContainer2"></div>
                            </div>
                        </div>
                        
                        <div class="dispenser-unit">
                            <div class="motor-housing" id="motorLabel">M1</div>
                            <div class="motor-direction-indicator" id="motorDirIndicator">↻/↺</div>
                            <div class="rotating-disc" id="rotatingDisc">
                                <div class="disc-marker"></div>
                                <div class="pusher-arm" id="pusherArm">
                                    <div class="pusher-head"></div>
                                </div>
                            </div>
                            <div class="sh-sensor-indicator sh11" id="sh11" title="SH11 - 0°"></div>
                            <div class="sh-sensor-indicator sh12" id="sh12" title="SH12 - 120°"></div>
                            <div class="sh-sensor-indicator sh13" id="sh13" title="SH13 - 240°"></div>
                            <div class="output-port port-left" id="portSO1">SO1</div>
                            <div class="output-port port-right" id="portSO2">SO2</div>
                        </div>
                        
                        <div class="motor-status-panel" id="motorStatus">대기 중</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>센서 상태 모니터</h2>
                <div class="sensor-panel">
                    <div class="sensor-row" id="sensorRowSF">
                        <div>
                            <div class="sensor-name">SF - Full Sensor</div>
                            <div class="sensor-desc">컬럼 만재 감지</div>
                        </div>
                        <div class="sensor-led" id="ledSF"></div>
                    </div>
                    <div class="sensor-row" id="sensorRowSC">
                        <div>
                            <div class="sensor-name">SC - Counter Sensor</div>
                            <div class="sensor-desc">입고 카운팅</div>
                        </div>
                        <div class="sensor-led" id="ledSC"></div>
                    </div>
                    <div class="sensor-row" id="sensorRowSO1">
                        <div>
                            <div class="sensor-name">SO1 - Left Output</div>
                            <div class="sensor-desc">좌측 출고 확인</div>
                        </div>
                        <div class="sensor-led" id="ledSO1"></div>
                    </div>
                    <div class="sensor-row" id="sensorRowSO2">
                        <div>
                            <div class="sensor-name">SO2 - Right Output</div>
                            <div class="sensor-desc">우측 출고 확인</div>
                        </div>
                        <div class="sensor-led" id="ledSO2"></div>
                    </div>
                    <div class="sensor-row" id="sensorRowSH">
                        <div>
                            <div class="sensor-name">SH - Home Position</div>
                            <div class="sensor-desc">모터 위치 제어 (3개)</div>
                        </div>
                        <div class="sensor-led" id="ledSH"></div>
                    </div>
                </div>
            </div>

            <div class="card log-container">
                <h2>시스템 로그</h2>
                <div class="log-box" id="logBox">
                    <div class="log-entry log-sensor">
                        <span class="timestamp">[00:00:00]</span>
                        <span>시스템 초기화 완료. TVM 시뮬레이터 준비됨.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const columns = {
            1: { tubes: [], maxCapacity: 12, depositCount: 0, withdrawCount: 0, errorCount: 0, motorId: 1 },
            2: { tubes: [], maxCapacity: 12, depositCount: 0, withdrawCount: 0, errorCount: 0, motorId: 1 },
            3: { tubes: [], maxCapacity: 12, depositCount: 0, withdrawCount: 0, errorCount: 0, motorId: 2 },
            4: { tubes: [], maxCapacity: 12, depositCount: 0, withdrawCount: 0, errorCount: 0, motorId: 2 }
        };

        const motorStates = {
            1: { isRunning: false, controllingColumn: null },
            2: { isRunning: false, controllingColumn: null }
        };

        let currentColumn = 1;
        let tubeIdCounter = 1;
        let isAnimating = false;

        function selectColumn(col) {
            currentColumn = col;
            document.getElementById('columnSelect').value = col;
            updateDisplay();
            const motorId = columns[col].motorId;
            addLog(`컬럼 ${col}로 전환되었습니다. (모터 M${motorId} 사용)`, 'sensor');
        }

        document.getElementById('maxCapacity').addEventListener('change', (e) => {
            const capacity = parseInt(e.target.value);
            columns[currentColumn].maxCapacity = capacity;
            updateDisplay();
            addLog(`컬럼 ${currentColumn} 최대 용량이 ${capacity}개로 설정되었습니다.`, 'sensor');
        });

        function getTimestamp() {
            const now = new Date();
            return now.toTimeString().split(' ')[0];
        }

        function addLog(message, type = 'sensor') {
            const logBox = document.getElementById('logBox');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="timestamp">[${getTimestamp()}]</span><span>${message}</span>`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        function activateSensor(sensorId, duration = 500) {
            const sensor = document.getElementById(sensorId);
            sensor.classList.add('active');
            
            const sensorType = sensorId.replace(/sensor/, '').replace(/^(SF|SC)[0-9]+$/, '$1');
            const led = document.getElementById('led' + sensorType);
            const row = document.getElementById('sensorRow' + sensorType);
            
            if (led) led.classList.add('active');
            if (row) row.classList.add('active');
            
            setTimeout(() => {
                sensor.classList.remove('active');
                if (led) led.classList.remove('active');
                if (row) row.classList.remove('active');
            }, duration);
        }

        let nextOutputSide = 'left';

        function activateMotor(columnId, duration = 1500) {
            return new Promise((resolve) => {
                const motorId = columns[columnId].motorId;
                const disc = document.getElementById('rotatingDisc');
                const pusher = document.getElementById('pusherArm');
                const sh11 = document.getElementById('sh11');
                const sh12 = document.getElementById('sh12');
                const sh13 = document.getElementById('sh13');
                const ledSH = document.getElementById('ledSH');
                const rowSH = document.getElementById('sensorRowSH');
                const motorStatus = document.getElementById('motorStatus');
                const dirIndicator = document.getElementById('motorDirIndicator');
                
                motorStates[motorId].isRunning = true;
                motorStates[motorId].controllingColumn = columnId;
                
                const isClockwise = columnId % 2 === 1;
                let currentAngle = 0;
                let rotationCount = 0;
                const totalSteps = 36;
                const angleStep = isClockwise ? 10 : -10;
                
                if (ledSH) ledSH.classList.add('active');
                if (rowSH) rowSH.classList.add('active');
                if (motorStatus) motorStatus.textContent = `M${motorId} 모터 시동 시작... (${isClockwise ? 'CW' : 'CCW'})`;
                if (dirIndicator) dirIndicator.textContent = isClockwise ? '↻ (CW)' : '↺ (CCW)';
                if (dirIndicator) dirIndicator.style.color = isClockwise ? 'var(--color-primary)' : 'var(--color-warning)';
                if (sh11) sh11.classList.add('active');
                
                addLog(`   ├─ M${motorId} - SH${motorId}1 센서 활성화 (0° - ${isClockwise ? '시계방향' : '반시계방향'})`, 'sensor');
                
                setTimeout(() => {
                    const interval = setInterval(() => {
                        currentAngle += angleStep;
                        rotationCount++;                if (disc) disc.style.transform = `translateX(-50%) translateY(-50%) rotate(${currentAngle}deg)`;
                if (pusher) pusher.style.transform = `rotate(${currentAngle}deg)`;
                        
                        if (motorStatus) {
                            motorStatus.textContent = `구동 중... (${currentAngle % 360}°)`;
                        }
                        
                        if (sh11 && sh12 && sh13) {
                            sh11.classList.remove('active');
                            sh12.classList.remove('active');
                            sh13.classList.remove('active');
                            
                            const normalizedAngle = ((currentAngle % 360) + 360) % 360;
                            
                            if (isClockwise) {
                                if (normalizedAngle >= 0 && normalizedAngle < 120) {
                                    sh11.classList.add('active');
                                } else if (normalizedAngle >= 120 && normalizedAngle < 240) {
                                    sh12.classList.add('active');
                                    if (rotationCount === 12) {
                                        addLog(`   ├─ M${motorId} - SH${motorId}2 센서 활성화 (120° CW)`, 'sensor');
                                    }
                                } else {
                                    sh13.classList.add('active');
                                    if (rotationCount === 24) {
                                        addLog(`   ├─ M${motorId} - SH${motorId}3 센서 활성화 (240° CW)`, 'sensor');
                                    }
                                }
                            } else {
                                if (normalizedAngle >= 240 || normalizedAngle < 120) {
                                    sh11.classList.add('active');
                                } else if (normalizedAngle >= 120 && normalizedAngle < 240) {
                                    sh13.classList.add('active');
                                    if (rotationCount === -12) {
                                        addLog(`   ├─ M${motorId} - SH${motorId}3 센서 활성화 (240° CCW)`, 'sensor');
                                    }
                                } else {
                                    sh12.classList.add('active');
                                    if (rotationCount === -24) {
                                        addLog(`   ├─ M${motorId} - SH${motorId}2 센서 활성화 (120° CCW)`, 'sensor');
                                    }
                                }
                            }
                        }
                        
                        if (Math.abs(rotationCount) >= totalSteps) {
                            clearInterval(interval);
                            
                            if (disc) disc.style.transform = 'translateX(-50%) translateY(-50%) rotate(0deg)';
                            if (pusher) pusher.style.transform = 'rotate(0deg)';
                            if (sh11) sh11.classList.add('active');
                            if (sh12) sh12.classList.remove('active');
                            if (sh13) sh13.classList.remove('active');
                            if (dirIndicator) dirIndicator.textContent = '↻/↺';
                            if (dirIndicator) dirIndicator.style.color = 'var(--color-text-secondary)';
                            
                            if (motorStatus) motorStatus.textContent = `M${motorId} 홈 위치 복귀 (0°)`;
                            addLog(`   └─ M${motorId} 모터 홈 포지션 복귀 완료 (SH${motorId}1)`, 'sensor');
                            
                            setTimeout(() => {
                                if (sh11) sh11.classList.remove('active');
                                if (ledSH) ledSH.classList.remove('active');
                                if (rowSH) rowSH.classList.remove('active');
                                if (motorStatus) motorStatus.textContent = '대기 중';
                                motorStates[motorId].isRunning = false;
                                motorStates[motorId].controllingColumn = null;
                                resolve();
                            }, 600);
                        }
                    }, duration / totalSteps);
                }, 300);
            });
        }

        async function depositTube() {
            if (isAnimating) {
                addLog('⚠️ 이전 작업이 진행 중입니다. 잠시 후 다시 시도하세요.', 'error');
                return;
            }

            const column = columns[currentColumn];
            
            if (column.tubes.length >= column.maxCapacity) {
                addLog(`❌ 컬럼 ${currentColumn} 만재 상태 (Full). 입고 불가능.`, 'error');
                activateSensor(`sensorSF${currentColumn}`, 1000);
                column.errorCount++;
                updateStats();
                return;
            }

            isAnimating = true;
            const tubeId = tubeIdCounter++;
            
            addLog(`→ 컬럼 ${currentColumn}에 튜브 #${tubeId} 입고 시작`, 'deposit');

            const stackContainer = document.getElementById(`tubeStackContainer${currentColumn}`);
            const tube = document.createElement('div');
            tube.className = 'tube falling';
            tube.textContent = `#${tubeId}`;
            tube.style.position = 'absolute';
            tube.style.bottom = '500px'; // 높이가 늘어났으므로 시작점 상향
            tube.style.left = '50%';
            tube.style.transform = 'translateX(-50%)';
            stackContainer.appendChild(tube);

            await sleep(200);
            addLog(`   ├─ 튜브가 입구 슬롯을 통과 중...`, 'sensor');
            
            await sleep(200);
            activateSensor(`sensorSC${currentColumn}`, 600);
            addLog(`   ├─ SC${currentColumn} 센서 광선 차단! (튜브 감지)`, 'sensor');
            
            await sleep(100);
            addLog(`   └─ SC${currentColumn} 센서 카운터 +1`, 'sensor');
            
            // 튜브 적재 높이 계산 (간격 40px로 조정)
            const targetBottom = column.tubes.length * 40;
            tube.style.bottom = targetBottom + 'px';

            await sleep(1100);
            
            column.tubes.push(tubeId);
            column.depositCount++;
            
            addLog(`✓ 튜브 #${tubeId} 입고 완료. 현재 ${column.tubes.length}/${column.maxCapacity}개`, 'deposit');

            if (column.tubes.length === column.maxCapacity) {
                activateSensor(`sensorSF${currentColumn}`, 1500);
                addLog(`⚠️ SF${currentColumn} 센서 활성화: 컬럼 ${currentColumn} 만재 상태`, 'error');
            }

            tube.classList.remove('falling');
            updateStats();
            isAnimating = false;
        }

        async function withdrawTube() {
            if (isAnimating) {
                addLog('⚠️ 이전 작업이 진행 중입니다. 잠시 후 다시 시도하세요.', 'error');
                return;
            }

            const column = columns[currentColumn];
            const motorId = column.motorId;
            
            if (motorStates[motorId].isRunning) {
                const otherColumn = motorStates[motorId].controllingColumn;
                addLog(`⚠️ M${motorId} 모터가 컬럼 ${otherColumn} 작업 중입니다. 대기하세요.`, 'error');
                column.errorCount++;
                updateStats();
                return;
            }
            
            if (column.tubes.length === 0) {
                addLog(`❌ 컬럼 ${currentColumn} 비어있음. 출고 불가능.`, 'error');
                column.errorCount++;
                updateStats();
                return;
            }

            isAnimating = true;
            
            addLog(`← 컬럼 ${currentColumn}에서 튜브 출고 명령 수신`, 'withdraw');
            addLog(`⚙️ M${motorId} 모터 구동 시작 (SH${motorId}x 센서로 위치 제어)`, 'sensor');

            await activateMotor(currentColumn, 1500);

            const tubeId = column.tubes.shift();
            const container = document.getElementById('columnContainer');
            const stackContainer = document.getElementById(`tubeStackContainer${currentColumn}`);
            const tubes = stackContainer.querySelectorAll('.tube');
            const bottomTube = tubes[0];

            if (bottomTube) {
                const outputSide = currentColumn % 2 === 1 ? 'left' : 'right';
                const portId = outputSide === 'left' ? 'portSO1' : 'portSO2';
                const port = document.getElementById(portId);
                
                addLog(`   ├─ 튜브 #${tubeId}이 ${outputSide === 'left' ? '좌측' : '우측'} 배출구로 이동 중...`, 'withdraw');
                
                stackContainer.removeChild(bottomTube);
                container.appendChild(bottomTube);
                
                bottomTube.classList.add(outputSide === 'left' ? 'dispensing-left' : 'dispensing-right');
                bottomTube.style.bottom = '110px';
                bottomTube.style.width = '35px';
                bottomTube.style.height = '55px';
                
                await sleep(300);
                
                bottomTube.style.bottom = '60px';
                bottomTube.style.left = outputSide === 'left' ? '25%' : '75%';
                
                await sleep(400);
                
                if (port) port.classList.add('active');
                addLog(`   ├─ ${portId.toUpperCase()} 센서 광선 차단! (배출 감지)`, 'sensor');
                
                await sleep(300);
                
                if (port) port.classList.remove('active');
                addLog(`   └─ ${portId.toUpperCase()} 센서 출고 확인 완료`, 'sensor');
                
                bottomTube.style.bottom = '-50px';
                bottomTube.style.opacity = '0';

                await sleep(500);
                container.removeChild(bottomTube);
            }

            await sleep(100);
            
            const remainingTubes = stackContainer.querySelectorAll('.tube');
            remainingTubes.forEach((tube, index) => {
                // 남은 튜브들 재정렬 (간격 40px)
                tube.style.bottom = (index * 40) + 'px';
                tube.style.transition = 'bottom 0.6s ease-out';
            });

            column.withdrawCount++;
            addLog(`✓ 튜브 #${tubeId} 출고 완료. 현재 ${column.tubes.length}/${column.maxCapacity}개`, 'withdraw');

            updateStats();
            isAnimating = false;
        }

        function resetSimulation() {
            if (isAnimating) {
                addLog('⚠️ 애니메이션 진행 중에는 초기화할 수 없습니다.', 'error');
                return;
            }

            Object.keys(columns).forEach(key => {
                columns[key].tubes = [];
                columns[key].depositCount = 0;
                columns[key].withdrawCount = 0;
                columns[key].errorCount = 0;
            });

            const container = document.getElementById('columnContainer');
            [1, 2, 3, 4].forEach(col => {
                const stackContainer = document.getElementById(`tubeStackContainer${col}`);
                if (stackContainer) {
                    const tubesInStack = stackContainer.querySelectorAll('.tube');
                    tubesInStack.forEach(tube => stackContainer.removeChild(tube));
                }
            });
            const tubesInContainer = container.querySelectorAll('.tube');
            tubesInContainer.forEach(tube => container.removeChild(tube));

            tubeIdCounter = 1;
            updateStats();
            updateDisplay();

            document.getElementById('logBox').innerHTML = `
                <div class="log-entry log-sensor">
                    <span class="timestamp">[${getTimestamp()}]</span>
                    <span>시스템 초기화 완료. 모든 컬럼이 리셋되었습니다.</span>
                </div>
            `;
        }

        function updateStats() {
            const column = columns[currentColumn];
            document.getElementById('tubeCount').textContent = column.tubes.length;
            document.getElementById('depositCount').textContent = column.depositCount;
            document.getElementById('withdrawCount').textContent = column.withdrawCount;
            document.getElementById('errorCount').textContent = column.errorCount;
        }

        function updateDisplay() {
            const motorId = columns[currentColumn].motorId;
            document.getElementById('currentColumn').textContent = currentColumn;
            document.getElementById('maxCapacity').value = columns[currentColumn].maxCapacity;
            
            const motorLabel = document.getElementById('motorLabel');
            const motorLabel2 = document.getElementById('motorLabel2');
            if (motorLabel) motorLabel.textContent = `M${motorId}`;
            if (motorLabel2) motorLabel2.textContent = `M${motorId}`;
            
            const motorColumns = document.getElementById('motorColumns');
            if (motorColumns) {
                const col1 = motorId === 1 ? 1 : 3;
                const col2 = motorId === 1 ? 2 : 4;
                motorColumns.textContent = `${col1}, ${col2}`;
            }
            
            [1, 2, 3, 4].forEach(col => {
                const stackContainer = document.getElementById(`tubeStackContainer${col}`);
                if (!stackContainer) return;
                
                const oldTubes = stackContainer.querySelectorAll('.tube');
                oldTubes.forEach(tube => stackContainer.removeChild(tube));

                columns[col].tubes.forEach((tubeId, index) => {
                    const tube = document.createElement('div');
                    tube.className = 'tube';
                    tube.textContent = `#${tubeId}`;
                    tube.style.position = 'absolute';
                    // 뷰 업데이트 시에도 간격 40px 적용
                    tube.style.bottom = (index * 40) + 'px';
                    tube.style.left = '50%';
                    tube.style.transform = 'translateX(-50%)';
                    stackContainer.appendChild(tube);
                });
            });
            
            const col1 = motorId === 1 ? 1 : 3;
            const col2 = motorId === 1 ? 2 : 4;
            document.getElementById(`column${col1}View`).style.display = 'block';
            document.getElementById(`column${col2}View`).style.display = 'block';
            const hideCol1 = motorId === 1 ? 3 : 1;
            const hideCol2 = motorId === 1 ? 4 : 2;
            document.getElementById(`column${hideCol1}View`).style.display = 'none';
            document.getElementById(`column${hideCol2}View`).style.display = 'none';

            updateAllColumnsGrid();
            updateStats();
        }

        function updateAllColumnsGrid() {
            const grid = document.getElementById('allColumnsGrid');
            grid.innerHTML = '';
            
            [1, 2, 3, 4].forEach(col => {
                const miniCol = document.createElement('div');
                miniCol.className = 'mini-column' + (col === currentColumn ? ' selected' : '');
                miniCol.onclick = () => selectColumn(col);
                
                const header = document.createElement('div');
                header.className = 'mini-column-header';
                const motorId = columns[col].motorId;
                header.textContent = `컬럼 ${col} (M${motorId})`;
                miniCol.appendChild(header);
                
                const tubesContainer = document.createElement('div');
                tubesContainer.style.cssText = 'display: flex; flex-direction: column-reverse; height: 140px; justify-content: flex-start; align-items: center; overflow: hidden;';
                
                columns[col].tubes.slice(0, 8).forEach(tubeId => {
                    const miniTube = document.createElement('div');
                    miniTube.className = 'mini-tube';
                    miniTube.textContent = `${tubeId}`;
                    tubesContainer.appendChild(miniTube);
                });
                
                miniCol.appendChild(tubesContainer);
                
                const status = document.createElement('div');
                status.className = 'mini-status';
                const count = columns[col].tubes.length;
                const max = columns[col].maxCapacity;
                status.textContent = `${count}/${max}`;
                if (count === max) {
                    status.style.color = 'var(--color-error)';
                    status.style.fontWeight = '600';
                }
                miniCol.appendChild(status);
                
                grid.appendChild(miniCol);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        updateDisplay();
    </script>
</body>
</html>
